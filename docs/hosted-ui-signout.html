<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Cognito認証デモ - Hosted UI サインアウト検証</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="importmap">
      {
        "imports": {
          "jwt-decode": "https://esm.sh/jwt-decode@4.0.0"
        }
      }
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen py-8 px-4"
  >
    <div class="max-w-4xl mx-auto space-y-8">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
          🔐 AWS Cognito Hosted UI サインアウト検証
        </h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          Hosted UI を使用した認証セッションのサインアウト動作を検証します。<br />
          <span class="text-blue-600">
            ※ ユーザープール設定、Hosted UI
            設定はセッションストレージで管理します
          </span>
        </p>
      </div>

      <!-- Cognito 設定 -->
      <div id="cognitoConfig"></div>

      <!-- Hosted UI 設定 -->
      <div id="hostedUIConfig"></div>

      <!-- サインアウトセクション -->
      <div
        id="signoutSection"
        class="hidden bg-gradient-to-r from-slate-50 to-rose-50 rounded-xl shadow-lg p-8 border-l-4 border-rose-500"
      >
        <h2
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          🚪 Hosted UI サインアウト
        </h2>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <button
            onclick="logoutFromHostedUI()"
            class="w-full bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200"
          >
            🌐 Hosted UI を使用して認証したときのサインアウト
          </button>
        </div>
      </div>

      <!-- 検証ポイント -->
      <div
        class="bg-gradient-to-r from-slate-50 to-rose-50 rounded-xl shadow-lg p-8 border-l-4 border-rose-500"
      >
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          📋 Hosted UI サインアウト検証ポイント
        </h3>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <ul class="space-y-4 text-gray-700">
            <li class="flex items-start gap-3">
              <span class="w-2 h-2 bg-rose-500 rounded-full mt-2"></span>
              <div>
                Hosted UI
                経由のサインアウトについて専用のログアウトエンドポイント
                `/logout` を使用して行うことの確認
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span class="w-2 h-2 bg-rose-500 rounded-full mt-2"></span>
              <div>
                Hosted UI 上のオリジンに紐づく Cookie について有効期限を
                1970-01-01 に更新することによる失効の動作を確認
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span class="w-2 h-2 bg-rose-500 rounded-full mt-2"></span>
              <div>
                サインアウト後の戻り先設定として `logout_uri`
                に設定されたページに 302 リダイレクトすることを確認
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <script type="module">
      import "./scripts/menu.js";
      import {
        SESSION_KEYS,
        getSession,
        removeSession,
      } from "./scripts/session-manager.js";
      import { setupCognitoConfig } from "./scripts/cognito-config.js";
      import {
        setupHostedUIConfig,
        generateLogoutURL,
      } from "./scripts/hosted-ui-config.js";

      fetch("components/cognito-config.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("cognitoConfig").innerHTML = html;

          setupCognitoConfig();
        });

      fetch("components/hosted-ui-config.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("hostedUIConfig").innerHTML = html;

          setupHostedUIConfig();
        });

      // Cognito（ユーザープール）設定と Hosted UI 設定の両方が埋まっている必要があるため雑だけど 0.5 秒間隔でチェック
      let prevCognitoConfig = null;
      let prevHostedUIConfig = null;
      setInterval(() => {
        const cognitoConfig = getSession(SESSION_KEYS.CONFIG);
        const hostedUIConfig = getSession(SESSION_KEYS.HOSTED_UI_CONFIG);
        const signoutSection = document.getElementById("signoutSection");

        // 値の変更があったときのみ処理
        if (
          cognitoConfig !== prevCognitoConfig ||
          hostedUIConfig !== prevHostedUIConfig
        ) {
          prevCognitoConfig = cognitoConfig;
          prevHostedUIConfig = hostedUIConfig;

          const bothPresent = cognitoConfig && hostedUIConfig;

          if (signoutSection) {
            signoutSection.classList.toggle("hidden", !bothPresent);
          }
        }
      }, 500);

      // Hosted UI サインアウトに遷移
      window.logoutFromHostedUI = function () {
        const config = getSession(SESSION_KEYS.CONFIG);
        const hostedUIConfig = getSession(SESSION_KEYS.HOSTED_UI_CONFIG);

        if (!hostedUIConfig.domain || !config.clientId) {
          alert("設定が不足しています。");
          return;
        }

        // サインアウト URL についてトップページを指定しているため、「Hosted UI でサインアウト ⇒ 当検証ページ側でセッションストレージ削除」のような手順は作れない。。
        // コールバック URL と同じ要領でサインアウト専用の処理を行うリダイレクトページを作るのが正解だったかも？
        const logoutUrl = generateLogoutURL(config, hostedUIConfig);
        console.log("Hosted UI サインアウトに遷移:", logoutUrl);

        // ※本来はここでやるべきではないかもしれない処理
        // サインアウト後のURLがトップページなのでセッションストレージで管理する認証情報はここで先に破棄する
        removeSession(SESSION_KEYS.AUTH_DATA);

        window.location.href = logoutUrl;
      };
    </script>
  </body>
</html>

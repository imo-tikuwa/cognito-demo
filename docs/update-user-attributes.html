<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Cognitoèªè¨¼ãƒ‡ãƒ¢ - èªè¨¼ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§æ›´æ–°</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="importmap">
      {
        "imports": {
          "@aws-sdk/client-cognito-identity-provider": "https://esm.sh/@aws-sdk/client-cognito-identity-provider@3.835.0?bundle"
        }
      }
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen py-8 px-4"
  >
    <div class="max-w-4xl mx-auto space-y-8">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
          âœï¸ èªè¨¼ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§æ›´æ–°
        </h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã§æ¨™æº–ã‹ã¤ç¢ºèªä¸è¦ã§ç®¡ç†å¯èƒ½ãªå±æ€§ã«ã¤ã„ã¦
          Read/Update/Delete ã®æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
        </p>
      </div>

      <!-- ç¾åœ¨ã®å±æ€§è¡¨ç¤º -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-blue-500"
      >
        <h3
          class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-6"
        >
          ğŸ“‹ ç¾åœ¨ã®å±æ€§
        </h3>

        <div id="currentAttributesContainer">
          <div
            id="currentAttributesList"
            class="bg-white rounded-lg p-4 shadow-sm border border-gray-200"
          >
            <div class="flex items-center justify-center py-8">
              <div
                class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"
              ></div>
              <span class="ml-2 text-gray-600">å±æ€§ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- å±æ€§æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-green-500"
      >
        <div class="flex items-center justify-between mb-6">
          <h3
            class="text-xl font-semibold text-gray-800 flex items-center gap-2"
          >
            âœï¸ å±æ€§æ›´æ–°
          </h3>
          <button
            id="addAttributeField"
            class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center gap-2"
          >
            <span class="text-lg">+</span>
            é …ç›®è¿½åŠ 
          </button>
        </div>

        <div id="attributeFieldsContainer" class="space-y-4"></div>

        <div class="mt-6 text-center">
          <button
            id="updateAttributes"
            class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:hover:shadow-md"
          >
            <span id="updateButtonText">å±æ€§ã‚’æ›´æ–°</span>
            <div
              id="updateButtonSpinner"
              class="!hidden inline-flex items-center"
            >
              <div
                class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"
              ></div>
              æ›´æ–°ä¸­...
            </div>
          </button>
        </div>
      </div>

      <!-- æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-yellow-500"
      >
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          ğŸ“‹ æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ
        </h3>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <ul class="space-y-4 text-gray-700">
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-blue-600">GetUserCommand</strong>
                ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨ã®å±æ€§ã‚’å–å¾—ã—ã¾ã™
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-green-600"
                  >UpdateUserAttributesCommand</strong
                >
                ã§ç¢ºèªä¸è¦ãªæ¨™æº–å±æ€§ã®ã¿ã‚’æ›´æ–°ã—ã¾ã™
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-red-500 rounded-full mt-2"
              ></span>
              <div>
                ä¸€éƒ¨ã®å±æ€§ã¯
                <strong class="text-red-600">
                  DeleteUserAttributesCommand
                </strong>
                ã§å‰Šé™¤ã§ãã¾ã™
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-yellow-500 rounded-full mt-2"
              ></span>
              <div>emailã€phone_numberç­‰ã®ç¢ºèªãŒå¿…è¦ãªå±æ€§ã¯é™¤å¤–ã—ã¦ã„ã¾ã™</div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        CognitoIdentityProviderClient,
        GetUserCommand,
        UpdateUserAttributesCommand,
        DeleteUserAttributesCommand,
      } from "@aws-sdk/client-cognito-identity-provider";
      import { SESSION_KEYS, getSession } from "./scripts/session-manager.js";

      // ç¢ºèªä¸è¦ãªæ¨™æº–å±æ€§ã®ãƒªã‚¹ãƒˆ
      const EDITABLE_ATTRIBUTES = [
        { name: "given_name", label: "åå‰" },
        { name: "family_name", label: "å§“" },
        { name: "middle_name", label: "ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ " },
        { name: "nickname", label: "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " },
        { name: "preferred_username", label: "å¸Œæœ›ãƒ¦ãƒ¼ã‚¶ãƒ¼å" },
        { name: "profile", label: "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«" },
        { name: "picture", label: "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL" },
        { name: "website", label: "ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ" },
        { name: "gender", label: "æ€§åˆ¥" },
        { name: "birthdate", label: "ç”Ÿå¹´æœˆæ—¥" },
        { name: "zoneinfo", label: "ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³" },
        { name: "locale", label: "ãƒ­ã‚±ãƒ¼ãƒ«" },
        { name: "address", label: "ä½æ‰€" },
        { name: "updated_at", label: "æ›´æ–°æ—¥æ™‚" },
        { name: "name", label: "ãƒ•ãƒ«ãƒãƒ¼ãƒ " },
      ];

      // å‰Šé™¤ä¸å¯èƒ½ãªå±æ€§ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•ã§ç®¡ç†ã™ã‚‹å±æ€§ + èªè¨¼ã§ä½¿ç”¨ã™ã‚‹å±æ€§ï¼‰
      const NON_EDITABLE_ATTRIBUTES = [
        "sub",
        "email",
        "email_verified",
        "phone_number",
        "phone_number_verified",
        "updated_at",
      ];

      // åˆæœŸãƒã‚§ãƒƒã‚¯
      const savedConfig = getSession(SESSION_KEYS.CONFIG);
      const savedAuthData = getSession(SESSION_KEYS.AUTH_DATA);

      if (!savedConfig || !savedAuthData || !savedAuthData.AccessToken) {
        alert(
          "ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯Cognitoè¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚èªè¨¼ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚"
        );
        location.href = "./auth-and-token-verify";
      }

      const cognitoClient = new CognitoIdentityProviderClient({
        region: savedConfig.region,
      });

      let fieldCounter = 0;
      let currentAttributes = {};
      let isUpdating = false;

      // æ›´æ–°ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¤‰æ›´
      function setUpdateButtonState(updating) {
        isUpdating = updating;
        const button = document.getElementById("updateAttributes");
        const buttonText = document.getElementById("updateButtonText");
        const spinner = document.getElementById("updateButtonSpinner");

        if (updating) {
          button.disabled = true;
          buttonText.classList.add("hidden");
          spinner.classList.remove("!hidden");
        } else {
          button.disabled = false;
          buttonText.classList.remove("hidden");
          spinner.classList.add("!hidden");
        }
      }

      // å±æ€§ã‚’å‰Šé™¤
      window.deleteAttribute = async function (attributeName) {
        const attributeLabel =
          EDITABLE_ATTRIBUTES.find((attr) => attr.name === attributeName)
            ?.label || attributeName;

        if (
          !window.confirm(
            `${attributeLabel} (${attributeName}) ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`
          )
        ) {
          return;
        }

        try {
          const command = new DeleteUserAttributesCommand({
            AccessToken: savedAuthData.AccessToken,
            UserAttributeNames: [attributeName],
          });

          await cognitoClient.send(command);
          alert(`${attributeLabel} (${attributeName}) ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

          // ç¾åœ¨ã®å±æ€§ã‚’å†å–å¾—
          await loadCurrentAttributes();
        } catch (e) {
          alert(`å±æ€§å‰Šé™¤å¤±æ•—: ${e.message}`);
        }
      };

      // ç¾åœ¨ã®å±æ€§ã‚’å–å¾—
      async function loadCurrentAttributes() {
        try {
          const command = new GetUserCommand({
            AccessToken: savedAuthData.AccessToken,
          });

          const response = await cognitoClient.send(command);
          currentAttributes = {};

          // å±æ€§ã‚’æ•´ç†
          response.UserAttributes.forEach((attr) => {
            currentAttributes[attr.Name] = attr.Value;
          });

          // è¡¨ç¤ºã‚’æ›´æ–°
          displayCurrentAttributes();
        } catch (e) {
          alert(`å±æ€§å–å¾—å¤±æ•—: ${e.message}`);
        }
      }

      // ç¾åœ¨ã®å±æ€§ã‚’è¡¨ç¤º
      function displayCurrentAttributes() {
        const container = document.getElementById("currentAttributesList");

        let html = "<div class='grid grid-cols-1 md:grid-cols-2 gap-4'>";

        Object.entries(currentAttributes).forEach(([key, value]) => {
          const canDelete = !NON_EDITABLE_ATTRIBUTES.includes(key);
          const attribute = EDITABLE_ATTRIBUTES.find(
            (attr) => attr.name === key
          );
          const attributeLabel = attribute
            ? `${attribute.label} (${attribute.name})`
            : key;

          html += `
            <div class="bg-gray-50 p-3 rounded-lg flex items-start justify-between">
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-600">${attributeLabel}</div>
                <div class="text-gray-800 break-all">${value}</div>
              </div>
              ${
                canDelete
                  ? `
                <button
                  onclick="deleteAttribute('${key}')"
                  class="flex-shrink-0 ml-2 bg-red-500 hover:bg-red-600 text-white w-6 h-6 rounded-full font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center text-sm"
                  title="å‰Šé™¤"
                >
                  âˆ’
                </button>
              `
                  : `
                <div class="flex-shrink-0 ml-2 w-6 h-6 flex items-center justify-center">
                  <span class="text-gray-400 text-xs" title="å‰Šé™¤ä¸å¯">ğŸ”’</span>
                </div>
              `
              }
            </div>
          `;
        });

        html += "</div>";
        container.innerHTML = html;
      }

      // å±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
      function addAttributeField() {
        fieldCounter++;
        const container = document.getElementById("attributeFieldsContainer");

        const fieldDiv = document.createElement("div");
        fieldDiv.className =
          "bg-white rounded-lg p-4 shadow-sm border border-gray-200";
        fieldDiv.id = `attributeField_${fieldCounter}`;

        fieldDiv.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">å±æ€§å</label>
              <select class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="attrName_${fieldCounter}">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                ${EDITABLE_ATTRIBUTES.map(
                  (attr) =>
                    `<option value="${attr.name}">${attr.label} (${attr.name})</option>`
                ).join("")}
              </select>
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">å€¤</label>
              <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="attrValue_${fieldCounter}" placeholder="å±æ€§å€¤ã‚’å…¥åŠ›">
            </div>
            <div class="flex-shrink-0">
              <label class="block text-sm font-medium text-gray-700 mb-2 opacity-0">å‰Šé™¤</label>
              <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 h-10 w-10 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" onclick="removeAttributeField(${fieldCounter})" id="removeBtn_${fieldCounter}">
                <span class="text-lg">âˆ’</span>
              </button>
            </div>
          </div>
        `;

        container.appendChild(fieldDiv);

        // å±æ€§é¸æŠæ™‚ã«ç¾åœ¨ã®å€¤ã‚’è‡ªå‹•å…¥åŠ›
        const selectElement = document.getElementById(
          `attrName_${fieldCounter}`
        );
        const inputElement = document.getElementById(
          `attrValue_${fieldCounter}`
        );

        selectElement.addEventListener("change", (e) => {
          const selectedAttr = e.target.value;
          if (selectedAttr && currentAttributes[selectedAttr]) {
            inputElement.value = currentAttributes[selectedAttr];
          }
        });

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        updateRemoveButtonStates();
      }

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆ1è¡Œã®å ´åˆã¯å‰Šé™¤ä¸å¯ï¼‰
      function updateRemoveButtonStates() {
        const container = document.getElementById("attributeFieldsContainer");
        const fields = container.querySelectorAll('[id^="attributeField_"]');

        fields.forEach((field) => {
          const id = field.id.split("_")[1];
          const removeBtn = document.getElementById(`removeBtn_${id}`);

          if (removeBtn) {
            if (fields.length === 1) {
              removeBtn.disabled = true;
              removeBtn.title = "æœ€ä½1ã¤ã®å…¥åŠ›æ¬„ãŒå¿…è¦ã§ã™";
            } else {
              removeBtn.disabled = false;
              removeBtn.title = "ã“ã®è¡Œã‚’å‰Šé™¤";
            }
          }
        });
      }

      // å±æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
      window.removeAttributeField = function (id) {
        const fieldDiv = document.getElementById(`attributeField_${id}`);
        if (fieldDiv) {
          fieldDiv.remove();
          // å‰Šé™¤å¾Œã«æ®‹ã‚Šã®å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          updateRemoveButtonStates();
        }
      };

      // å±æ€§ã‚’æ›´æ–°
      async function updateAttributes() {
        if (isUpdating) return;

        try {
          const container = document.getElementById("attributeFieldsContainer");
          const fields = container.querySelectorAll('[id^="attributeField_"]');

          // å…¥åŠ›å€¤ã®ãƒã‚§ãƒƒã‚¯ã¨æ›´æ–°ç”¨ãƒ‡ãƒ¼ã‚¿ã®çµ„ã¿ç«‹ã¦
          const userAttributes = [];
          const ids = [];
          for (const field of fields) {
            const id = field.id.split("_")[1];
            const nameElement = document.getElementById(`attrName_${id}`);
            const valueElement = document.getElementById(`attrValue_${id}`);

            const hasDuplicates = userAttributes.find(
              (attr) => attr.Name === nameElement.value
            );
            if (hasDuplicates) {
              alert("é‡è¤‡ã™ã‚‹å±æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
              return;
            } else if (valueElement.value === "") {
              alert("å€¤ãŒç©ºç™½ã®å±æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
              return;
            }

            ids.push(id);
            userAttributes.push({
              Name: nameElement.value,
              Value: valueElement.value,
            });
          }

          if (userAttributes.length === 0) {
            alert("æ›´æ–°ã™ã‚‹å¯¾è±¡ã®å±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            return;
          }

          setUpdateButtonState(true);

          const command = new UpdateUserAttributesCommand({
            AccessToken: savedAuthData.AccessToken,
            UserAttributes: userAttributes,
          });

          await cognitoClient.send(command);
          alert(`${userAttributes.length}å€‹ã®å±æ€§ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);

          // ç¾åœ¨ã®å±æ€§æ›´æ–°ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¨å‰Šé™¤ï¼†1è¡Œè¿½åŠ 
          for (const id of ids) {
            removeAttributeField(id);
          }
          addAttributeField();

          // ç¾åœ¨ã®å±æ€§ã‚’å†å–å¾—
          await loadCurrentAttributes();
        } catch (e) {
          alert(`å±æ€§æ›´æ–°å¤±æ•—: ${e.message}`);
        } finally {
          setUpdateButtonState(false);
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document
        .getElementById("addAttributeField")
        .addEventListener("click", addAttributeField);
      document
        .getElementById("updateAttributes")
        .addEventListener("click", updateAttributes);

      // åˆæœŸçŠ¶æ…‹ã§å±æ€§ã‚’èª­ã¿è¾¼ã¿ã€1ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
      loadCurrentAttributes();
      addAttributeField();
    </script>
  </body>
</html>

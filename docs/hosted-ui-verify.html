<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Cognitoèªè¨¼ãƒ‡ãƒ¢ - Hosted UI æ¤œè¨¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="importmap">
      {
        "imports": {
          "jwt-decode": "https://esm.sh/jwt-decode@4.0.0"
        }
      }
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen py-8 px-4"
  >
    <div class="max-w-4xl mx-auto space-y-8">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
          ğŸ” AWS Cognito Hosted UI æ¤œè¨¼ãƒ‡ãƒ¢
        </h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          AWS Cognito ã® Hosted UI ï¼ˆãŠã‚ˆã³
          ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ï¼‰ã‚’ä½¿ç”¨ã—ãŸèªè¨¼ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚<br />
          <span class="text-blue-600">
            â€» ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«è¨­å®šã€Hosted UI
            è¨­å®šã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™
          </span>
        </p>
      </div>

      <!-- Cognito è¨­å®š -->
      <div id="cognitoConfig"></div>

      <!-- Hosted UI è¨­å®š -->
      <div id="hostedUIConfig"></div>

      <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div
        id="authExecuteSection"
        class="hidden bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-indigo-500 transition-all duration-300"
      >
        <h2
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          ğŸ” Hosted UI èªè¨¼
        </h2>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <div class="space-y-4">
            <button
              onclick="redirectToHostedUI()"
              id="signInBtn"
              class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200"
            >
              ğŸŒ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»
            </button>
          </div>
        </div>
      </div>

      <!-- æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-blue-500"
      >
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          ğŸ“‹ Hosted UI æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ
        </h3>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <ul class="space-y-4 text-gray-700">
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-blue-600">OAuth2/OpenID Connect</strong> -
                æ¨™æº–çš„ãªèªè¨¼ãƒ•ãƒ­ãƒ¼ã«æº–æ‹ 
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-blue-600">Authorization Code Flow</strong>
                - èªè¨¼å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆï¼ˆcallback.htmlï¼‰ã§ code
                ã‚’å…ƒã«ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã¨ã®äº¤æ›ã‚’æ¤œè¨¼
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-blue-600">ãƒãƒãƒ¼ã‚¸ãƒ‰UI</strong> -
                AWSãŒæä¾›ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®æ¤œè¨¼ã‚’å®Ÿæ–½
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <script type="module">
      import { SESSION_KEYS, getSession } from "./scripts/session-manager.js";
      import { setupCognitoConfig } from "./scripts/cognito-config.js";
      import {
        setupHostedUIConfig,
        generateAuthURL,
      } from "./scripts/hosted-ui-config.js";

      fetch("components/cognito-config.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("cognitoConfig").innerHTML = html;

          setupCognitoConfig();
        });

      fetch("components/hosted-ui-config.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("hostedUIConfig").innerHTML = html;

          setupHostedUIConfig();
        });

      // Cognitoï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ï¼‰è¨­å®šã¨ Hosted UI è¨­å®šã®ä¸¡æ–¹ãŒåŸ‹ã¾ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚é›‘ã ã‘ã© 0.5 ç§’é–“éš”ã§ãƒã‚§ãƒƒã‚¯
      let prevCognitoConfig = null;
      let prevHostedUIConfig = null;
      setInterval(() => {
        const cognitoConfig = getSession(SESSION_KEYS.CONFIG);
        const hostedUIConfig = getSession(SESSION_KEYS.HOSTED_UI_CONFIG);
        const authExecuteSection =
          document.getElementById("authExecuteSection");

        // å€¤ã®å¤‰æ›´ãŒã‚ã£ãŸã¨ãã®ã¿å‡¦ç†
        if (
          cognitoConfig !== prevCognitoConfig ||
          hostedUIConfig !== prevHostedUIConfig
        ) {
          prevCognitoConfig = cognitoConfig;
          prevHostedUIConfig = hostedUIConfig;

          const bothPresent = cognitoConfig && hostedUIConfig;

          if (authExecuteSection) {
            authExecuteSection.classList.toggle("hidden", !bothPresent);
          }
        }
      }, 500);

      // Hosted UI ã«é·ç§»
      window.redirectToHostedUI = function () {
        const config = getSession(SESSION_KEYS.CONFIG);
        const hostedUIConfig = getSession(SESSION_KEYS.HOSTED_UI_CONFIG);

        if (!hostedUIConfig.domain) {
          alert("Hosted UI ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        const authUrl = generateAuthURL(config, hostedUIConfig);
        console.log("Hosted UI ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:", authUrl);

        // åŒä¸€ã‚¿ãƒ–ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = authUrl;
      };
    </script>
  </body>
</html>

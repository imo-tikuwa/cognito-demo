<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Cognitoèªè¨¼ãƒ‡ãƒ¢ - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§å†èªè¨¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="importmap">
      {
        "imports": {
          "@aws-sdk/client-cognito-identity-provider": "https://esm.sh/@aws-sdk/client-cognito-identity-provider@3.835.0?bundle",
          "jwt-decode": "https://esm.sh/jwt-decode@4.0.0"
        }
      }
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen py-8 px-4"
  >
    <div class="max-w-4xl mx-auto space-y-8">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
          ğŸ” ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§å†èªè¨¼
        </h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”¨ã„ã¦
          <code>REFRESH_TOKEN_AUTH</code>
          èªè¨¼ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹å†èªè¨¼ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚<br />
          <span class="text-blue-600"
            >â€» ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒã™ã‚‹è¨­å®šãƒ»èªè¨¼æƒ…å ±ãŒå¿…è¦ã§ã™</span
          >
        </p>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div
        id="errorAlert"
        class="hidden text-red-700 bg-gradient-to-r from-red-50 to-pink-50 p-4 rounded-lg border-l-4 border-red-400 font-medium"
      ></div>

      <!-- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§å†èªè¨¼ -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-indigo-500 text-center"
      >
        <button
          id="tryRefresh"
          class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200"
        >
          ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§å†èªè¨¼
        </button>
      </div>

      <!-- çµæœè¡¨ç¤º -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-emerald-500"
      >
        <div
          id="refreshTryed"
          class="hidden bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 p-4 rounded-lg mb-6 border-l-4 border-green-400 font-semibold"
        >
          âœ… å†èªè¨¼æˆåŠŸï¼ˆREFRESH_TOKEN_AUTHï¼‰
        </div>

        <!-- IDãƒˆãƒ¼ã‚¯ãƒ³ã®æƒ…å ±ã‚’è¡¨ç¤º -->
        <div id="idTokenDisplaySection"></div>
      </div>

      <!-- æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-blue-500"
      >
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          ğŸ“‹ æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ
        </h3>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <ul class="space-y-4 text-gray-700">
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-blue-600">REFRESH_TOKEN_AUTH</strong>
                ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šã€ ID/ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†å–å¾—ã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"
              ></span>
              <div>
                ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚ŒãŸ
                <code>RefreshToken</code> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
                æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-yellow-500 rounded-full mt-2"
              ></span>
              <div>
                <strong class="text-yellow-600">ã‚ˆãã‚ã‹ã£ã¦ãªã„ç‚¹:</strong>
                ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§
                <code>ALLOW_REFRESH_TOKEN_AUTH</code> ãŒç„¡åŠ¹ã§ã‚‚
                ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ãŒæˆåŠŸã™ã‚‹ï¼Ÿï¼Ÿ
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-purple-500 rounded-full mt-2"
              ></span>
              <div>
                æˆåŠŸæ™‚ã¯æ–°ã—ã„ ID
                ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
              </div>
            </li>
            <li class="flex items-start gap-3">
              <span
                class="flex-shrink-0 w-2 h-2 bg-red-500 rounded-full mt-2"
              ></span>
              <div>
                å¤±æ•—æ™‚ã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã€ã¾ãŸã¯ãƒ•ãƒ­ãƒ¼ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        CognitoIdentityProviderClient,
        InitiateAuthCommand,
      } from "@aws-sdk/client-cognito-identity-provider";
      import { setCurrentUser } from "./scripts/cognito-config.js";
      import { updateIdTokenDisplay } from "./scripts/id-token-display.js";
      import { SESSION_KEYS, getSession } from "./scripts/session-manager.js";

      // åˆæœŸãƒã‚§ãƒƒã‚¯: Cognito è¨­å®š ã¾ãŸã¯ èªè¨¼çµæœæƒ…å ± ãŒç„¡ã„å ´åˆã¯èªè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      const savedConfig = getSession(SESSION_KEYS.CONFIG);
      const savedAuthData = getSession(SESSION_KEYS.AUTH_DATA);

      if (
        !savedConfig ||
        !savedConfig.clientId ||
        !savedAuthData ||
        !savedAuthData.RefreshToken
      ) {
        alert(
          "ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯Cognitoè¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚èªè¨¼ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚"
        );
        location.href = "./auth-and-token-verify";
      }

      fetch("components/id-token-display.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("idTokenDisplaySection").innerHTML = html;

          // ç¾åœ¨ã®IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¡¨ç¤º
          updateIdTokenDisplay(savedAuthData);
        });

      document
        .getElementById("tryRefresh")
        .addEventListener("click", async () => {
          const alertDiv = document.getElementById("errorAlert");
          alertDiv.classList.add("hidden");

          try {
            const command = new InitiateAuthCommand({
              AuthFlow: "REFRESH_TOKEN_AUTH",
              ClientId: savedConfig.clientId,
              AuthParameters: {
                REFRESH_TOKEN: savedAuthData.RefreshToken,
              },
            });

            // Cognitoã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
            const cognitoClient = new CognitoIdentityProviderClient({
              region: savedConfig.region,
            });
            const response = await cognitoClient.send(command);
            setCurrentUser({
              ...response.AuthenticationResult,
              RefreshToken: savedAuthData.RefreshToken,
            });

            // IDãƒˆãƒ¼ã‚¯ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateIdTokenDisplay(response.AuthenticationResult);

            document.getElementById("refreshTryed").classList.remove("hidden");
          } catch (e) {
            alertDiv.textContent = `å†èªè¨¼å¤±æ•—: ${e.message}`;
            alertDiv.classList.remove("hidden");
          }
        });
    </script>
  </body>
</html>

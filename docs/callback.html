<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Cognitoèªè¨¼ãƒ‡ãƒ¢ - Hosted UI ã‹ã‚‰ã®èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen py-8 px-4"
  >
    <div class="max-w-4xl mx-auto space-y-8">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
          ğŸ”„ Hosted UI ã‹ã‚‰ã®èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        </h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          Hosted UI ã‹ã‚‰ã®èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™...
        </p>
      </div>

      <!-- å‡¦ç†çŠ¶æ…‹è¡¨ç¤º -->
      <div
        id="processingSection"
        class="bg-gradient-to-r from-slate-50 to-blue-50 rounded-xl shadow-lg p-8 border-l-4 border-blue-500"
      >
        <div class="flex items-center justify-center gap-4">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"
          ></div>
          <span class="text-lg font-semibold text-gray-800">
            èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†ä¸­...
          </span>
        </div>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="errorResultSection" class="hidden"></div>
    </div>

    <script type="module">
      import "./scripts/menu.js";
      import {
        SESSION_KEYS,
        getSession,
        setSession,
      } from "./scripts/session-manager.js";

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      const error = urlParams.get("error");
      const errorDescription = urlParams.get("error_description");

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      if (error) {
        showError(error, errorDescription);
      } else if (code) {
        // èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        exchangeCodeForTokens(code);
      } else {
        showError(
          "invalid_request",
          "ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
        );
      }

      async function exchangeCodeForTokens(code) {
        try {
          const config = getSession(SESSION_KEYS.CONFIG);
          const hostedUIConfig = getSession(SESSION_KEYS.HOSTED_UI_CONFIG);

          if (!config || !hostedUIConfig) {
            throw new Error("è¨­å®šæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’å†æ§‹æˆ
          const currentOrigin = window.location.origin;
          const basePath = window.location.pathname.includes("/cognito-demo/")
            ? "/cognito-demo"
            : "";
          const redirectUri = `${currentOrigin}${basePath}/callback.html`;

          // ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          const tokenEndpoint = `${hostedUIConfig.domain}/oauth2/token`;
          const response = await fetch(tokenEndpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              grant_type: "authorization_code",
              client_id: config.clientId,
              code: code,
              redirect_uri: redirectUri,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: ${errorData.error} - ${errorData.error_description}`
            );
          }

          const tokenData = await response.json();

          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«èªè¨¼æƒ…å ±ä¿å­˜
          const authData = {
            AccessToken: tokenData.access_token,
            ExpiresIn: tokenData.expires_in,
            IdToken: tokenData.id_token,
            RefreshToken: tokenData.refresh_token,
            TokenType: tokenData.token_type,
          };
          setSession(SESSION_KEYS.AUTH_DATA, authData);

          alert(
            "èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸï¼\nèªè¨¼å¾Œã®æƒ…å ±ç¢ºèªã‚’è¡Œã†ãŸã‚ã« auth-and-token-verify.html ç”»é¢ã«é·ç§»ã—ã¾ã™"
          );
          location.href = "./auth-and-token-verify";
        } catch (error) {
          console.error("Token exchange error:", error);
          showError("token_exchange_failed", error.message);
        }
      }

      function showError(error, description) {
        const processingSection = document.getElementById("processingSection");
        const errorResultSection =
          document.getElementById("errorResultSection");

        processingSection.classList.add("hidden");
        errorResultSection.classList.remove("hidden");

        errorResultSection.innerHTML = `
          <div class="bg-gradient-to-r from-slate-50 to-red-50 rounded-xl shadow-lg p-8 border-l-4 border-red-500">
            <div class="bg-gradient-to-r from-red-100 to-pink-100 text-red-800 p-4 rounded-lg border-l-4 border-red-400 font-semibold">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-red-500">âŒ</span>
                <span>HostedUIèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ</span>
              </div>
              <div class="text-sm text-red-700">
                <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error}<br>
                <strong>è©³ç´°:</strong> ${
                  description || "ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¯ä¸æ˜ã§ã™"
                }
              </div>
            </div>
          </div>
        `;
      }
    </script>
  </body>
</html>

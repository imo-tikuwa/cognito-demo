<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS Cognitoèªè¨¼ãƒ‡ãƒ¢ - IDãƒ—ãƒ¼ãƒ«ã®æ¤œè¨¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="importmap">
      {
        "imports": {
          "@aws-sdk/client-cognito-identity": "https://esm.sh/@aws-sdk/client-cognito-identity@3.835.0?bundle",
          "@aws-sdk/client-sts": "https://esm.sh/@aws-sdk/client-sts@3.835.0?bundle",
          "jwt-decode": "https://esm.sh/jwt-decode@4.0.0"
        }
      }
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-slate-200 min-h-screen py-8 px-4"
  >
    <div class="max-w-4xl mx-auto space-y-8">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-3">
          ğŸ” AWS Cognito IDãƒ—ãƒ¼ãƒ«æ¤œè¨¼ãƒ‡ãƒ¢
        </h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          Cognitoãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦IDãƒ—ãƒ¼ãƒ«ã‹ã‚‰AWSã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã—ã€<br />
          å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIAMãƒ­ãƒ¼ãƒ«æƒ…å ±ãªã©ã‚’ç¢ºèªã—ã¾ã™ã€‚<br />
          <span class="text-blue-600">
            â€» ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã®èªè¨¼ã¨IDãƒ—ãƒ¼ãƒ«è¨­å®šã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ç®¡ç†
          </span>
        </p>
      </div>

      <!-- IDãƒ—ãƒ¼ãƒ«è¨­å®š -->
      <div id="identityPoolConfig"></div>

      <!-- ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ± -->
      <div
        class="bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-emerald-500"
      >
        <div
          class="hidden bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 p-4 rounded-lg mb-6 border-l-4 border-green-400 font-semibold"
        >
          ğŸ« ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±
        </div>

        <!-- IDãƒˆãƒ¼ã‚¯ãƒ³ã®æƒ…å ±ã‚’è¡¨ç¤º -->
        <div id="idTokenDisplaySection"></div>
      </div>

      <!-- ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æ¤œè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div
        id="credentialVerifySection"
        class="hidden bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-emerald-500"
      >
        <h2
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          ğŸ” ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æ¤œè¨¼
        </h2>
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <p class="text-sm text-gray-600 mb-4">
            IDãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å–å¾—ã—ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¾ã™ã€‚
          </p>
          <button
            onclick="verifyCredential()"
            id="verifyCredentialBtn"
            class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200"
          >
            ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’æ¤œè¨¼
          </button>
        </div>
      </div>

      <!-- ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«å–å¾—çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div
        id="credentialVerifyResultSection"
        class="hidden bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl shadow-lg p-8 border-l-4 border-emerald-500"
      >
        <h2
          class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2"
        >
          ğŸ“‹ ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«å–å¾—çµæœ
        </h2>
        <div
          id="credentialVerifyResult"
          class="text-sm text-gray-800 space-y-2"
        ></div>
        <div id="copyAwsCliCommandSection" class="mt-4">
          <button
            onclick="copyAwsCliCommand()"
            class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200"
          >
            ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã« aws-cli ç”¨ã®S3ãƒã‚±ãƒƒãƒˆä¸€è¦§å–å¾—ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        CognitoIdentityClient,
        GetIdCommand,
        GetCredentialsForIdentityCommand,
      } from "@aws-sdk/client-cognito-identity";
      import { GetCallerIdentityCommand, STSClient } from "@aws-sdk/client-sts";
      import { updateIdTokenDisplay } from "./scripts/id-token-display.js";
      import { SESSION_KEYS, getSession } from "./scripts/session-manager.js";
      import { setupIdentityPoolConfig } from "./scripts/identity-pool-config.js";

      // åˆæœŸãƒã‚§ãƒƒã‚¯: Cognito è¨­å®š ã¾ãŸã¯ èªè¨¼çµæœæƒ…å ± ãŒç„¡ã„å ´åˆã¯èªè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      const savedConfig = getSession(SESSION_KEYS.CONFIG);
      const savedAuthData = getSession(SESSION_KEYS.AUTH_DATA);

      if (
        !savedConfig ||
        !savedConfig.region ||
        !savedAuthData ||
        !savedAuthData.IdToken
      ) {
        alert(
          "Cognitoè¨­å®šãŒå­˜åœ¨ã—ãªã„ or èªè¨¼ã—ã¦ã„ã¾ã›ã‚“ã€‚èªè¨¼ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚"
        );
        location.href = "./auth-and-token-verify";
      }

      fetch("components/identity-pool-config.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("identityPoolConfig").innerHTML = html;

          setupIdentityPoolConfig();
        });

      fetch("components/id-token-display.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("idTokenDisplaySection").innerHTML = html;
          // ç¾åœ¨ã®IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¡¨ç¤º
          updateIdTokenDisplay(savedAuthData);
        });

      // ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’æ¤œè¨¼
      window.verifyCredential = async function () {
        const verifyCredentialBtn = document.getElementById(
          "verifyCredentialBtn"
        );
        verifyCredentialBtn.disabled = true;
        verifyCredentialBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div><span>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</span></div>`;

        const credentialVerifyResultSection = document.getElementById(
          "credentialVerifyResultSection"
        );
        const credentialVerifyResult = document.getElementById(
          "credentialVerifyResult"
        );
        const copyAwsCliCommandSection = document.getElementById(
          "copyAwsCliCommandSection"
        );
        try {
          const currentUser = getSession(SESSION_KEYS.AUTH_DATA);
          const userPoolConfig = getSession(SESSION_KEYS.CONFIG);
          const idPoolConfig = getSession(SESSION_KEYS.IDENTITY_POOL_CONFIG);

          const cognitoIdentity = new CognitoIdentityClient({
            region: idPoolConfig.region,
          });
          const identityResponse = await cognitoIdentity.send(
            new GetIdCommand({
              IdentityPoolId: idPoolConfig.identityPoolId,
              Logins: {
                [`cognito-idp.${userPoolConfig.region}.amazonaws.com/${userPoolConfig.userPoolId}`]:
                  currentUser.IdToken,
              },
            })
          );

          const credentialsResponse = await cognitoIdentity.send(
            new GetCredentialsForIdentityCommand({
              IdentityId: identityResponse.IdentityId,
              Logins: {
                [`cognito-idp.${userPoolConfig.region}.amazonaws.com/${userPoolConfig.userPoolId}`]:
                  currentUser.IdToken,
              },
            })
          );

          // å½“åˆã¯S3ã®ãƒã‚±ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã ã£ãŸã¨ã“ã‚
          // å›é¿ã§ããªã„CORSã‚¨ãƒ©ãƒ¼ã®å•é¡Œã‚’å—ã‘ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ï¼ˆå–å¾—ã—ãŸã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã®ç™ºè¡Œå…ƒã®ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèªã®ã¿å®Ÿæ–½ï¼‰
          const stsClient = new STSClient({
            region: idPoolConfig.region,
            credentials: {
              accessKeyId: credentialsResponse.Credentials.AccessKeyId,
              secretAccessKey: credentialsResponse.Credentials.SecretKey,
              sessionToken: credentialsResponse.Credentials.SessionToken,
            },
          });
          const callerIdentity = await stsClient.send(
            new GetCallerIdentityCommand({})
          );

          credentialVerifyResult.innerHTML = `
            <div class="text-green-700 bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border-l-4 border-green-400 font-medium mt-4">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-green-500">âœ…</span>
                <strong>ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã®å–å¾—ã«æˆåŠŸã—ã¾ã—ãŸ</strong>
              </div>
              <div class="truncate">
                <strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID:</strong> ${callerIdentity.Account}
              </div>
              <div class="truncate">
                <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> ${callerIdentity.UserId}
              </div>
              <div class="truncate">
                <strong>ARN:</strong> ${callerIdentity.Arn}
              </div>
              <div class="truncate">
                <strong>AWS_ACCESS_KEY_ID:</strong>
                <code id="accessKeyId">${credentialsResponse.Credentials.AccessKeyId}</code>
              </div>
              <div class="truncate">
                <strong>AWS_SECRET_ACCESS_KEY:</strong>
                <code id="secretKey">${credentialsResponse.Credentials.SecretKey}</code>
              </div>
              <div class="truncate">
                <strong>AWS_SESSION_TOKEN:</strong>
                <code id="sessionToken">${credentialsResponse.Credentials.SessionToken}</code>
              </div>
              <div class="truncate">
                <strong>REGION:</strong>
                <code id="region">${idPoolConfig.region}</code>
              </div>
            </div>
          `;
          copyAwsCliCommandSection.classList.remove("hidden");
        } catch (error) {
          console.error("ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:", error);
          credentialVerifyResult.innerHTML = `
            <div class="text-red-700 bg-gradient-to-r from-red-50 to-pink-50 p-4 rounded-lg border-l-4 border-red-400 font-medium mt-4">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-red-500">âŒ</span>
                <strong>ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong>
              </div>
              <div class="text-sm">
                <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}
              </div>
            </div>
          `;
          copyAwsCliCommandSection.classList.add("hidden");
        } finally {
          verifyCredentialBtn.disabled = false;
          verifyCredentialBtn.innerHTML = "ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’æ¤œè¨¼";
          credentialVerifyResultSection.classList.remove("hidden");
        }
      };

      // aws-cliã§S3ã®ãƒã‚±ãƒƒãƒˆä¸€è¦§å–å¾—ã‚’è¡Œã†ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      // â€»ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã¯S3ãƒã‚±ãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«ã¤ã„ã¦CORSç”±æ¥ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ aws-cli ã§æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
      window.copyAwsCliCommand = function () {
        const accessKeyId = document.getElementById("accessKeyId").innerText;
        const secretKey = document.getElementById("secretKey").innerText;
        const sessionToken = document.getElementById("sessionToken").innerText;
        const region = document.getElementById("region").innerText;
        const cmd = `AWS_ACCESS_KEY_ID=${accessKeyId} AWS_SECRET_ACCESS_KEY=${secretKey} AWS_SESSION_TOKEN=${sessionToken} AWS_DEFAULT_REGION=${region} aws s3 ls`;
        navigator.clipboard.writeText(cmd).then(() => {
          alert("aws-cliç”¨ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        });
      };
    </script>
  </body>
</html>
